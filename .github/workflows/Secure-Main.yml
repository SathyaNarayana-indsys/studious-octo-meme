name: Security Pipeline
run-name: Commit - ${{ github.sha }} on ${{ github.ref_name }}

# This workflow is designed to be called by another workflow.
on:
  workflow_call:
    inputs:
      break_on_failure:
        description: 'Set to true for normal flow (fails on security issues) or false for emergency deployment (always proceeds).'
        required: false
        type: boolean
        default: true
      serviceVersion:
        description: 'Optional service version tag.'
        required: false
        type: string
        default: "NA"
      repo_link:
        description: 'The target repository link for reports (e.g., owner/repo).'
        required: false
        type: string
        default: ${{ vars.REPO_LINK }}
      deployment_type:
        description: 'Deployment target type (e.g., VM or Container).'
        required: false
        type: string
        default: VM
      runScript:
        description: 'In case of a VM deployment, the script to be executed on the VM.'
        required: false
        type: string
      deploymentFolder:
        description: 'The target deployment folder for VM deployments.'
        required: false
        type: string
      BuildRequried:
        description: 'Is Build Required'
        required: false
        type: string
      BuildLanguage:
        description: 'Which Language build script to execute'
        required: false
        type: string
      DryRun:
        description: 'If true, skips deployment steps.'
        required: false
        type: boolean
        default: false
      executionRequired:
        required: false
        type: boolean
        default: false
      environmentName: 
        required: false
        type: string
        default: main
      envType:
        required: false
        type: string
        default: "AWS"
      repoUser:
        required: false
        type: string
        default: "ssm-user"
        
jobs:
  sast:
    name: Running SAST [BearerCLI]
    runs-on: ubuntu-latest
    outputs:
      output_json: ${{ steps.sast-output.outputs.outputJson }}
      encryption_key: ${{ steps.sast-output.outputs.encryptionKey }}
      has_findings: ${{ steps.sast-output.outputs.hasFindings }}
    steps:
      - name:  Checkout code
        uses: actions/checkout@v4

      - name: Run Bearer SAST
        uses: ./.github/actions/Security-SAST

  sbom_generator:
    name: Running Syft [SBOM generator]
    runs-on: ubuntu-latest
    outputs:
      output_json: ${{ steps.sbom-output.outputs.outputJson }}
      encryption_key: ${{ steps.sbom-output.outputs.encryptionKey }}
      has_findings: ${{ steps.sbom-output.outputs.hasFindings }}
    steps:
      - name:  Checkout code
        uses: actions/checkout@v4
        
      - name: Generate SBOM with Syft
        uses: ./.github/actions/Security-SBOM

  secret_detection:
    name: Running Truffle-Hog
    runs-on: ubuntu-latest
    outputs:
      output_json: ${{ steps.secrets-output.outputs.outputJson }}
      encryption_key: ${{ steps.secrets-output.outputs.encryptionKey }}
      has_findings: ${{ steps.secrets-output.outputs.hasFindings }}
    steps:
      - name:  Checkout code
        uses: actions/checkout@v4
        
      - name: Generate SBOM with Syft
        uses: ./.github/actions/Security-Secret_Detection

  sca:
    name: Running Grype [SCA]
    runs-on: ubuntu-latest
    outputs:
      output_json: ${{ steps.sca-output.outputs.outputJson }}
      encryption_key: ${{ steps.sca-output.outputs.encryptionKey }}
      has_findings: ${{ steps.sca-output.outputs.hasFindings }}
    steps:
      - name:  Checkout code
        uses: actions/checkout@v4
        
      - name: Run Grype (Anchore Scan)
        uses: ./.github/actions/Security-SCA

  PublishOutput:
    name: Publish Security Reports
    runs-on: ubuntu-latest
    needs: [sast, sbom_generator, secret_detection, sca]
    if: always()
    steps:
      - name: Publish the Reports
        uses: ./.github/actions/Security-Publish_Output
        with:
          repo_link: ${{ inputs.repo_link }}
          reports_repo_pat: ${{ secrets.REPORTS_REPO_PAT }}
          sast_report: ${{ needs.sast.outputs.output_json }}
          sast_key: ${{ needs.sast.outputs.encryption_key }}
          sbom_report: ${{ needs.sbom_generator.outputs.output_json }}
          sbom_key: ${{ needs.sbom_generator.outputs.encryption_key }}
          secret_report: ${{ needs.secret_detection.outputs.output_json }}
          secret_key: ${{ needs.secret_detection.outputs.encryption_key }}
          sca_report: ${{ needs.sca.outputs.output_json }}
          sca_key: ${{ needs.sca.outputs.encryption_key }}

  pre_build:
    name: Pre-Build Security Check
    runs-on: ubuntu-latest
    needs: [sast, sbom_generator, secret_detection, sca]
    if: always()
    env:
      BREAK_ON_FAILURE_FLAG: ${{ inputs.break_on_failure }}
    outputs:
      proceed: ${{ steps.check.outputs.proceed }}
    steps:
      - name: Security Output Check Step
        id: check
        run: |
          if [[ "$BREAK_ON_FAILURE_FLAG" == "true" ]]; then
            echo "BREAK_ON_FAILURE_FLAG is true: checking all security scan findings."
            
            SAST_FINDINGS="${{ needs.sast.outputs.has_findings }}"
            SECRET_FINDINGS="${{ needs.secret_detection.outputs.has_findings }}"
            SCA_FINDINGS="${{ needs.sca.outputs.has_findings }}"
            
            echo "Security Scan Results:"
            echo "  SAST findings: $SAST_FINDINGS"
            echo "  SBOM findings: $SBOM_FINDINGS"
            echo "  Secret Detection findings: $SECRET_FINDINGS"
            echo "  SCA findings: $SCA_FINDINGS"
            
            # Check if ANY security scan has findings (excluding SBOM as it's informational)
            if [[ "$SAST_FINDINGS" == "true" ]] || \
               [[ "$SECRET_FINDINGS" == "true" ]] || \
               [[ "$SCA_FINDINGS" == "true" ]]; then
              
              echo "Security issues detected. Halting deployment."
              
              if [[ "$SAST_FINDINGS" == "true" ]]; then
                echo "  - SAST scan found code security issues"
              fi
              if [[ "$SECRET_FINDINGS" == "true" ]]; then
                echo "  - Secret detection found exposed secrets"
              fi
              if [[ "$SCA_FINDINGS" == "true" ]]; then
                echo "  - SCA scan found vulnerable dependencies"
              fi
              
              echo "proceed=false" >> $GITHUB_OUTPUT
              exit 1
            else
              echo "All security checks passed. Proceeding with build/deployment."
              echo "proceed=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "BREAK_ON_FAILURE_FLAG is false: proceeding regardless of security scan findings."
            echo "proceed=true" >> $GITHUB_OUTPUT
          fi

  build:
    name: Run Custom Build Script (if it exists)
    runs-on: ubuntu-latest
    needs: pre_build
    if: |
      always() && 
      needs.pre_build.result == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Run Custom Build Step
        id: build_check
        run: |
          BUILD_SCRIPT="${{ inputs.BuildScript }}"
          
          # Check if the BuildScript input is empty or "NA" (the default value)
          if [[ -z "$BUILD_SCRIPT" ]] || [[ "$BUILD_SCRIPT" == "NA" ]]; then
            echo "::notice file=custom_build::No BuildScript provided in inputs. Skipping build steps."
            echo "No custom build script was provided."
            # Exit with success (0) as requested,/ which is the shell's default for a successful run.
            exit 0
          fi
          
          # If the script is provided, proceed with execution
          echo "Executing custom build script: $BUILD_SCRIPT"
          
          # Ensure the script file exists
          if [ ! -f "$BUILD_SCRIPT" ]; then
            echo "::error file=custom_build::BuildScript file '$BUILD_SCRIPT' not found in the repository."
            exit 1 # Exit with failure if script file is missing
          fi
          
          # Make the script executable and run it
          chmod +x "$BUILD_SCRIPT"
          ./"$BUILD_SCRIPT"

  # vm_deploy:
  #   name: VM Deployment Process
  #   needs: [build]
  #   if: |
  #     always() &&
  #     needs.build.result == 'success' &&
  #     !inputs.DryRun && 
  #     (inputs.deployment_type == 'VM' || inputs.deployment_type == 'vm' || inputs.deployment_type == 'Server' || inputs.deployment_type == 'server')
  #   uses: ./.github/workflows/VM-Deployment.yml
  #   with:
  #     runScript: ${{ inputs.runScript }}
  #     deploymentFolder: ${{ inputs.deploymentFolder }}
  #     executionRequired: ${{ inputs.executionRequired }}
  #     environmentName: ${{ inputs.environmentName }}
  #   secrets: inherit

  # container_deploy:
  #   name: Container Deployment Process
  #   needs: [build]
  #   if: |
  #     always() &&
  #     needs.build.result == 'success' &&
  #     !inputs.DryRun && 
  #     (inputs.deployment_type == 'Container' || inputs.deployment_type == 'container' || inputs.deployment_type == 'microservice')
  #   uses: ./.github/workflows/Container-Deployment.yml