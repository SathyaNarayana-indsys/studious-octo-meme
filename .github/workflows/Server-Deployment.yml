name: Secure AWS VM Deployment Pipeline
run-name: Commit - ${{ github.sha }} on ${{ github.ref_name }}

# This workflow is designed to be called by another workflow.
on:
  workflow_call:
    inputs:
      break_on_failure:
        description: 'Set to true for normal flow (fails on security issues) or false for emergency deployment (always proceeds).'
        required: false
        type: string
        default: true
      serviceVersion:
        description: 'Optional service version tag.'
        required: false
        type: string
        default: "NA"
      repo_link:
        description: 'The target repository link for reports (e.g., owner/repo).'
        required: false
        type: string
        default: ${{ vars.REPO_LINK }}
      deploymentFolder:
        description: 'The target deployment folder for VM deployments.'
        required: false
        type: string
      BuildRequried:
        description: 'Is Build Required'
        required: false
        type: string
      BuildLanguage:
        description: 'Which Language build script to execute'
        required: false
        type: string
      DryRun:
        description: 'If true, skips deployment steps.'
        required: false
        type: string
        default: "false"
      executionRequired:
        required: false
        type: string
        default: "false"
      repoUser:
        required: false
        type: string
        default: "ssm-user"
      runScript:                          
        required: false
        type: string
      envRegion:                          
        required: false
        type: string
        default: "ap-south-1"
      environment:
        required: false
        type: string
        default: "UAT"

jobs:
  sast:
    name: Running SAST [BearerCLI]
    runs-on: ubuntu-latest
    outputs:
      output_json: ${{ steps.sast-output.outputs.outputJson }}
      encryption_key: ${{ steps.sast-output.outputs.encryptionKey }}
      has_findings: ${{ steps.sast-output.outputs.hasFindings }}
    steps:
      - name:  Checkout code
        uses: actions/checkout@v4

      - name: Run Bearer SAST
        id: sast-output
        uses: SathyaNarayana-indsys/studious-octo-meme/.github/actions/Security-SAST

  sbom_generator:
    name: Running Syft [SBOM generator]
    runs-on: ubuntu-latest
    outputs:
      output_json: ${{ steps.sbom-output.outputs.outputJson }}
      encryption_key: ${{ steps.sbom-output.outputs.encryptionKey }}
      has_findings: ${{ steps.sbom-output.outputs.hasFindings }}
    steps:
      - name:  Checkout code
        uses: actions/checkout@v4
        
      - name: Generate SBOM with Syft
        id: sbom-output
        uses: SathyaNarayana-indsys/studious-octo-meme/.github/actions/Security-SBOM

  secret_detection:
    name: Running Truffle-Hog
    runs-on: ubuntu-latest
    outputs:
      output_json: ${{ steps.secrets-output.outputs.outputJson }}
      encryption_key: ${{ steps.secrets-output.outputs.encryptionKey }}
      has_findings: ${{ steps.secrets-output.outputs.hasFindings }}
    steps:
      - name:  Checkout code
        uses: actions/checkout@v4
        
      - name: Detect Secrets using TruffleHog
        id: secrets-output
        uses: SathyaNarayana-indsys/studious-octo-meme/.github/actions/Security-Secret_Detection

  sca:
    name: Running Grype [SCA]
    runs-on: ubuntu-latest
    outputs:
      output_json: ${{ steps.sca-output.outputs.outputJson }}
      encryption_key: ${{ steps.sca-output.outputs.encryptionKey }}
      has_findings: ${{ steps.sca-output.outputs.hasFindings }}
    steps:
      - name:  Checkout code
        uses: actions/checkout@v4
        
      - name: Run Grype (Anchore Scan)
        id: sca-output
        uses: SathyaNarayana-indsys/studious-octo-meme/.github/actions/Security-SCA

  PublishOutput:
    name: Publish Security Reports
    runs-on: ubuntu-latest
    needs: [sast, sbom_generator, secret_detection, sca]
    if: always()
    steps:
      - name: Checkout code          # â† still missing
        uses: actions/checkout@v4
      - name: Publish the Reports
        uses: SathyaNarayana-indsys/studious-octo-meme/.github/actions/Security-Publish_Output
        with:
          repo_link: ${{ inputs.repo_link }}
          reports_repo_pat: ${{ secrets.REPORTS_REPO_PAT }}
          sast_report: ${{ needs.sast.outputs.output_json }}
          sast_key: ${{ needs.sast.outputs.encryption_key }}
          sbom_report: ${{ needs.sbom_generator.outputs.output_json }}
          sbom_key: ${{ needs.sbom_generator.outputs.encryption_key }}
          secret_report: ${{ needs.secret_detection.outputs.output_json }}
          secret_key: ${{ needs.secret_detection.outputs.encryption_key }}
          sca_report: ${{ needs.sca.outputs.output_json }}
          sca_key: ${{ needs.sca.outputs.encryption_key }}

  PreBuild:
    name: Pre-Build Security Check
    runs-on: ubuntu-latest
    needs: [sast, sbom_generator, secret_detection, sca]
    if: always()
    env:
      BREAK_ON_FAILURE_FLAG: ${{ inputs.break_on_failure }}
    outputs:
      proceed: ${{ steps.check.outputs.proceed }}
    steps:
      - name: Security Output Check Step
        id: check
        run: |
          if [[ "$BREAK_ON_FAILURE_FLAG" == "true" ]]; then
            echo "BREAK_ON_FAILURE_FLAG is true: checking all security scan findings."
            
            SAST_FINDINGS="${{ needs.sast.outputs.has_findings }}"
            SECRET_FINDINGS="${{ needs.secret_detection.outputs.has_findings }}"
            SCA_FINDINGS="${{ needs.sca.outputs.has_findings }}"
            
            echo "Security Scan Results:"
            echo "  SAST findings: $SAST_FINDINGS"
            echo "  SBOM findings: informational"
            echo "  Secret Detection findings: $SECRET_FINDINGS"
            echo "  SCA findings: $SCA_FINDINGS"
            
            # Check if ANY security scan has findings (excluding SBOM as it's informational)
            if [[ "$SAST_FINDINGS" == "true" ]] || \
               [[ "$SECRET_FINDINGS" == "true" ]] || \
               [[ "$SCA_FINDINGS" == "true" ]]; then
              
              echo "Security issues detected. Halting deployment."
              
              if [[ "$SAST_FINDINGS" == "true" ]]; then
                echo "  - SAST scan found code security issues"
              fi
              if [[ "$SECRET_FINDINGS" == "true" ]]; then
                echo "  - Secret detection found exposed secrets"
              fi
              if [[ "$SCA_FINDINGS" == "true" ]]; then
                echo "  - SCA scan found vulnerable dependencies"
              fi
              
              echo "proceed=false" >> $GITHUB_OUTPUT
              exit 1
            else
              echo "All security checks passed. Proceeding with build/deployment."
              echo "proceed=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "BREAK_ON_FAILURE_FLAG is false: proceeding regardless of security scan findings."
            echo "proceed=true" >> $GITHUB_OUTPUT
          fi
  Build:
    name: Run Custom Build Script (if it exists)
    runs-on: ubuntu-latest
    needs: PreBuild
    if: |
      always() && 
      needs.PreBuild.result == 'success' 
    outputs:
      artifact_name: ${{ steps.springboot_build.outputs.artifact_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: SpringBoot Build 
        id: springboot_build
        if: inputs.BuildLanguage == 'SpringBoot' && inputs.BuildRequried == 'True'
        uses: SathyaNarayana-indsys/studious-octo-meme/.github/actions/Build-SpringBoot
      
      - name: No Build
        if: inputs.BuildRequried == 'False'
        shell: bash
        run: |
             echo "Skipping Build"
  
  Deploy:
    name: Deploy Artifact/Repo
    runs-on: ubuntu-latest
    needs: Build
    environment: ${{ inputs.environment }}
    if: inputs.DryRun != 'True'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Artifact Deploy
        if: inputs.BuildRequried == 'True'
        uses: SathyaNarayana-indsys/studious-octo-meme/.github/actions/Deploy-SSH-Artifact
        with:
          artifactName: ${{ needs.Build.outputs.artifact_name }}
          ServiceLanguage: ${{ inputs.BuildLanguage }}
          runScript: ${{ inputs.runScript }}
          deploymentFolder: ${{ inputs.deploymentFolder }}
          executionRequired: ${{ inputs.executionRequired }}

        ### Secrets as inputs ###
          SSH_HOST: ${{ secrets.INSTANCE_ID }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_USER: ${{ secrets.INSTANCE_USER }}
      
      - name: Repo Deploy
        if: inputs.BuildRequried == 'False'
        uses: SathyaNarayana-indsys/studious-octo-meme/.github/actions/Deploy-SSH-Repo
        with:
          runScript: ${{ inputs.runScript }}
          deploymentFolder: ${{ inputs.deploymentFolder }}
          executionRequired: ${{ inputs.executionRequired }}

        ### Secrets as inputs ###
          SSH_HOST: ${{ secrets.INSTANCE_ID }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_USER: ${{ secrets.INSTANCE_USER }}
